<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="eqlee.ctm.apply.guider.dao.GuiderMapper">


    <select id ="guiderIndex" resultType="eqlee.ctm.apply.guider.entity.vo.GuiderVo">
         select a.Id as 'id',b.LineName as 'lineName',convert(varchar(20),a.OutDate,23)outDate,a.AllNumber as 'allNumber',
        a.ContactName as 'contactName',a.ContactTel as 'contactTel',a.Place as 'place',a.AdultNumber as 'adultNumber',
        a.BabyNumber as 'babyNumber',a.OldNumber as 'oldNumber',a.ChildNumber as 'childNumber',a.AllPrice as 'allPrice',
        a.MsPrice as 'msPrice',a.ApplyRemark as 'applyRemark',a.CompanyName as 'companyName',a.IsSelect as 'isSelect',a.Type as 'type'
        from Apply a
        left join Line b  on a.LineId = b.Id
        <where>
            1 = 1
            and a.IsCancel = 0 and a.Statu = 1 and a.IsPayment = 1
            <if test="outDate != null">
                and a.OutDate = #{outDate}
            </if>
            <if test="city != null">
                and b.City = #{city}
            </if>
           <if test="lineId2 == null">
               <if test="lineId1 != null">
                   and b.Id = #{lineId1}
               </if>
           </if>
            <if test="lineId3 == null">
                <if test="lineId2 != null">
                    and (b.Id = #{lineId1} or b.Id = #{lineId2})
                </if>
            </if>
            <if test="lineId4 == null">
                <if test="lineId3 != null">
                    and (b.Id = #{lineId1} or b.Id = #{lineId2} or b.Id = #{lineId3})
                </if>
            </if>
            <if test="lineId5 == null">
                <if test="lineId4 != null">
                    and (b.Id = #{lineId1} or b.Id = #{lineId2} or b.Id = #{lineId3}
                    or b.Id = #{lineId4})
                </if>
            </if>
            <if test="lineId6 == null">
                <if test="lineId5 != null">
                    and (b.Id = #{lineId1} or b.Id = #{lineId2} or b.Id = #{lineId3}
                    or b.Id = #{lineId4} or b.Id = #{lineId5})
                </if>
            </if>
            <if test="lineId7 == null">
                <if test="lineId6 != null">
                    and (b.Id = #{lineId1} or b.Id = #{lineId2} or b.Id = #{lineId3}
                    or b.Id = #{lineId4} or b.Id = #{lineId5} or b.Id = #{lineId6})
                </if>
            </if>
            <if test="lineId7 != null">
                and (b.Id = #{lineId1} or b.Id = #{lineId2} or b.Id = #{lineId3}
                or b.Id = #{lineId4} or b.Id = #{lineId5} or b.Id = #{lineId6} or b.Id = #{lineId7})
            </if>
            <if test="region != null">
                <bind name="_region" value="'%' + region + '%'"/>
                and a.Place like #{_region}
            </if>
        </where>
        order by a.IsSelect,a.Place desc
    </select>

    <select id ="queryCountNumberInfo" resultType="eqlee.ctm.apply.guider.entity.vo.GuiderCountNumber">
        select sum(a.AllNumber)numberCount
        from Apply a
        left join Line b  on a.LineId = b.Id
        <where>
            1 = 1
            and a.IsCancel = 0 and a.Statu = 1 and a.IsPayment = 1 and a.IsSelect = 0
            <if test="outDate != null">
                and a.OutDate = #{outDate}
            </if>
            <if test="city != null">
                and b.City = #{city}
            </if>
            <if test="lineId2 == null">
                <if test="lineId1 != null">
                    and b.Id = #{lineId1}
                </if>
            </if>
            <if test="lineId3 == null">
                <if test="lineId2 != null">
                    and (b.Id = #{lineId1} or b.Id = #{lineId2})
                </if>
            </if>
            <if test="lineId4 == null">
                <if test="lineId3 != null">
                    and (b.Id = #{lineId1} or b.Id = #{lineId2} or b.Id = #{lineId3})
                </if>
            </if>
            <if test="lineId5 == null">
                <if test="lineId4 != null">
                    and (b.Id = #{lineId1} or b.Id = #{lineId2} or b.Id = #{lineId3}
                    or b.Id = #{lineId4})
                </if>
            </if>
            <if test="lineId6 == null">
                <if test="lineId5 != null">
                    and (b.Id = #{lineId1} or b.Id = #{lineId2} or b.Id = #{lineId3}
                    or b.Id = #{lineId4} or b.Id = #{lineId5})
                </if>
            </if>
            <if test="lineId7 == null">
                <if test="lineId6 != null">
                    and (b.Id = #{lineId1} or b.Id = #{lineId2} or b.Id = #{lineId3}
                    or b.Id = #{lineId4} or b.Id = #{lineId5} or b.Id = #{lineId6})
                </if>
            </if>
            <if test="lineId7 != null">
                and (b.Id = #{lineId1} or b.Id = #{lineId2} or b.Id = #{lineId3}
                or b.Id = #{lineId4} or b.Id = #{lineId5} or b.Id = #{lineId6} or b.Id = #{lineId7})
            </if>
            <if test="region != null">
                <bind name="_region" value="'%' + region + '%'"/>
                and a.Place like #{_region}
            </if>
        </where>
    </select>

    <select id ="guiderIndexByLine" resultType="eqlee.ctm.apply.guider.entity.vo.GuiderVo">
        <bind name="LineName" value="'%' + lineName + '%'"/>
        select * from(
        select max(Id)id,max(LineName)lineName,max(convert(varchar(20),OutDate,23))outDate,sum(AllNumber)allNumber,
        sum(case when isnull(IsSelect,0)=1 then isnull(AllNumber,0) else 0 end)slcCnt
        from(
        select a.Id,a.LineId,b.LineName,a.OutDate,a.AllNumber,a.IsSelect,a.IsCancel from Apply a
        left join Line b  on a.LineId = b.Id where a.IsCancel = 0 and a.Statu != 0 and a.IsPayment = 1)tab
        group by OutDate,LineId)tab where LineName like #{LineName}
        order by OutDate desc
    </select>

    <select id ="guiderIndexByTime" resultType="eqlee.ctm.apply.guider.entity.vo.GuiderVo">
         select * from(
        select max(Id)id,max(LineName)lineName,max(convert(varchar(20),OutDate,23))outDate,sum(AllNumber)allNumber,
        sum(case when isnull(IsSelect,0)=1 then isnull(AllNumber,0) else 0 end)slcCnt
        from(
        select a.Id,a.LineId,b.LineName,a.OutDate,a.AllNumber,a.IsSelect,a.IsCancel from Apply a
        left join Line b  on a.LineId = b.Id where a.IsCancel = 0 and a.Statu != 0 and a.IsPayment = 1)tab
        group by OutDate,LineId)tab where OutDate = #{outDate}
        order by OutDate desc
    </select>

    <select id ="guiderIndexByLineAndTime" resultType="eqlee.ctm.apply.guider.entity.vo.GuiderVo">
        <bind name="LineName" value="'%' + lineName + '%'"/>
        select * from(
        select max(Id)id,max(LineName)lineName,max(convert(varchar(20),OutDate,23))outDate,sum(AllNumber)allNumber,
        sum(case when isnull(IsSelect,0)=1 then isnull(AllNumber,0) else 0 end)slcCnt
        from(
        select a.Id,a.LineId,b.LineName,a.OutDate,a.AllNumber,a.IsSelect,a.IsCancel from Apply a
        left join Line b  on a.LineId = b.Id where a.IsCancel = 0 and a.Statu != 0 and a.IsPayment = 1)tab
        group by OutDate,LineId)tab where OutDate = #{outDate} and LineName like #{LineName}
        order by OutDate desc
    </select>



    <select id="applyIndex" resultType="eqlee.ctm.apply.guider.entity.vo.ApplyVo">
        select a.Id,a.AllNumber,a.ContactName,a.ContactTel,a.Region,a.Place,
        convert(varchar(20),a.OutDate,23)OutDate,b.LineName from Apply a
        join Line b on a.LineId = b.Id where a.OutDate = #{outDate} and b.Id = #{lineId}
        and isnull(a.IsSelect,0) = 0 and a.IsCancel = 0 and a.Statu != 0 and a.IsPayment = 1
    </select>

    <select id="queryApplyPerson" resultType="eqlee.ctm.apply.guider.entity.vo.ApplyVo">
        <bind name="Region_Name" value="'%' + region + '%'"/>
        select a.Id,a.AllNumber,a.ContactName,a.ContactTel,a.Region,a.Place,
        convert(varchar(20),a.OutDate,23)OutDate,b.LineName from Apply a
        join Line b on a.LineId = b.Id where  a.OutDate = #{outDate} and b.Id = #{lineId} and
        isnull(a.IsSelect,0) = 0 and a.IsCancel = 0 and a.Statu != 0 and a.IsPayment = 1
        and a.Place like #{Region_Name}
    </select>
</mapper>

