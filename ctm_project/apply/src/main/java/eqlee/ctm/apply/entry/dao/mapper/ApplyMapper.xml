<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="eqlee.ctm.apply.entry.dao.ApplyMapper">

    <select id="listPageApply" resultType="eqlee.ctm.apply.entry.entity.query.ApplyQuery">
     select * from (
      select max(LineName)LineName,max(Region)Region,max(convert(varchar(20),OutDate,23))OutDate,max(AdultPrice)AdultPrice,max(OldPrice)OldPrice,max(BabyPrice)BabyPrice,
        max(ChildPrice)ChildPrice,max(MaxNumber)MaxNumber,isnull(sum(DoAllNumber),0)DoAllNumber,max(TravelSituation)TravelSituation,max(MarketAdultPrice)MarketAdultPrice,
        max(MarketOldPrice)MarketOldPrice,max(MarketBabyPrice)MarketBabyPrice,max(MarketChildPrice)MarketChildPrice
        from VLinePrice
        group by LineId,OutDate
      )tab order by OutDate desc
    </select>


    <select id="listPageApplyByDate" resultType="eqlee.ctm.apply.entry.entity.query.ApplyQuery">
      select * from (
      select max(LineName)LineName,max(Region)Region,max(convert(varchar(20),OutDate,23))OutDate,max(AdultPrice)AdultPrice,max(OldPrice)OldPrice,max(BabyPrice)BabyPrice,
        max(ChildPrice)ChildPrice,max(MaxNumber)MaxNumber,isnull(sum(DoAllNumber),0)DoAllNumber,max(TravelSituation)TravelSituation,max(MarketAdultPrice)MarketAdultPrice,
        max(MarketOldPrice)MarketOldPrice,max(MarketBabyPrice)MarketBabyPrice,max(MarketChildPrice)MarketChildPrice
        from VLinePrice
        group by LineId,OutDate
      )tab where OutDate = #{OutDate} order by OutDate desc
    </select>

    <select id="listPageApplyByLine" resultType="eqlee.ctm.apply.entry.entity.query.ApplyQuery">
        <bind name="line_region_name" value="'%' + LineNameOrRegion + '%'"/>
        select * from (
        select max(LineName)LineName,max(Region)Region,max(convert(varchar(20),OutDate,23))OutDate,max(AdultPrice)AdultPrice,max(OldPrice)OldPrice,max(BabyPrice)BabyPrice,
        max(ChildPrice)ChildPrice,max(MaxNumber)MaxNumber,isnull(sum(DoAllNumber),0)DoAllNumber,max(TravelSituation)TravelSituation,max(MarketAdultPrice)MarketAdultPrice,
        max(MarketOldPrice)MarketOldPrice,max(MarketBabyPrice)MarketBabyPrice,max(MarketChildPrice)MarketChildPrice
        from VLinePrice
        group by LineId,OutDate
        )tab where LineName like #{line_region_name} or Region like #{line_region_name} order by OutDate desc
    </select>

    <select id="listPageApplyByAll" resultType="eqlee.ctm.apply.entry.entity.query.ApplyQuery">
        <bind name="line_region_name" value="'%' + LineNameOrRegion + '%'"/>
        select * from (
        select max(LineName)LineName,max(Region)Region,max(convert(varchar(20),OutDate,23))OutDate,max(AdultPrice)AdultPrice,max(OldPrice)OldPrice,max(BabyPrice)BabyPrice,
        max(ChildPrice)ChildPrice,max(MaxNumber)MaxNumber,isnull(sum(DoAllNumber),0)DoAllNumber,max(TravelSituation)TravelSituation,max(MarketAdultPrice)MarketAdultPrice,
        max(MarketOldPrice)MarketOldPrice,max(MarketBabyPrice)MarketBabyPrice,max(MarketChildPrice)MarketChildPrice
        from VLinePrice
        group by LineId,OutDate
        )tab where (LineName like #{line_region_name} or Region like #{line_region_name}) and OutDate = #{OutDate}
        order by OutDate desc
    </select>

    <select id="listPageDoApply" resultType="eqlee.ctm.apply.entry.entity.query.ApplyDoExaQuery">
      select a.Id,a.ApplyNo,convert(varchar(20),a.OutDate,23) as 'OutDate',b.LineName,a.AdultNumber,a.BabyNumber,a.OldNumber,a.ChildNumber,
      a.statu,a.CompanyName,a.CompanyUser,a.IsPayment,a.IsCancel,d.ExamineType
      from Apply a join Line b on a.LineId = b.Id join Examine d on a.Id = d.ApplyId
      where a.Statu = 0 and a.IsCancel = 0 and a.IsPayment = 1 ORDER by a.OutDate desc
    </select>

    <select id="listPageDoApplyByNoWithLine" resultType="eqlee.ctm.apply.entry.entity.query.ApplyDoExaQuery">
      <bind name="lineName_name" value="'%' + LineName + '%'"/>
      select a.Id,a.ApplyNo,convert(varchar(20),a.OutDate,23) as 'OutDate',b.LineName,a.AdultNumber,a.BabyNumber,a.OldNumber,a.ChildNumber,
      a.statu,a.CompanyName,a.CompanyUser,a.IsPayment,a.IsCancel,d.ExamineType
      from Apply a join Line b on a.LineId = b.Id join Examine d on a.Id = d.ApplyId
      where a.OutDate = #{outDate} and b.LineName like #{lineName_name} and a.Statu = 0 and a.IsCancel = 0 and a.IsPayment = 1
      ORDER by a.OutDate desc
    </select>

    <select id="listPageDoApplyByLineName" resultType="eqlee.ctm.apply.entry.entity.query.ApplyDoExaQuery">
      <bind name="lineName_name" value="'%' + LineName + '%'"/>
      select a.Id,a.ApplyNo,convert(varchar(20),a.OutDate,23) as 'OutDate',b.LineName,a.AdultNumber,a.BabyNumber,a.OldNumber,a.ChildNumber,
      a.statu,a.CompanyName,a.CompanyUser,a.IsPayment,a.IsCancel,d.ExamineType
      from Apply a join Line b on a.LineId = b.Id join Examine d on a.Id = d.ApplyId
      where b.LineName like #{lineName_name} and a.Statu = 0 and a.IsCancel = 0 and a.IsPayment = 1
      ORDER by a.OutDate desc
    </select>

    <select id="listPageDoApplyByNo" resultType="eqlee.ctm.apply.entry.entity.query.ApplyDoExaQuery">
        select a.Id,a.ApplyNo,convert(varchar(20),a.OutDate,23) as 'OutDate',b.LineName,a.AdultNumber,a.BabyNumber,a.OldNumber,a.ChildNumber,
        a.statu,a.CompanyName,a.CompanyUser,a.IsPayment,a.IsCancel,d.ExamineType
        from Apply a join Line b on a.LineId = b.Id join Examine d on a.Id = d.ApplyId
        where a.OutDate = #{outDate} and a.Statu = 0 and a.IsCancel = 0 and a.IsPayment = 1
        ORDER by a.OutDate desc
    </select>

    <select id="listPageDoApply2Company" resultType="eqlee.ctm.apply.entry.entity.query.ApplyCompanyQuery">
        select a.Id,a.ApplyNo,convert(varchar(20),a.OutDate,23) as 'OutDate',b.LineName,a.AllNumber,
        a.ContactName,a.ContactTel,a.Statu
        from Apply a join Line b on a.LineId = b.Id where a.CompanyName = #{CompanyName}
        ORDER by a.OutDate desc
    </select>

    <select id="listPageDoApply2CompanyByTime" resultType="eqlee.ctm.apply.entry.entity.query.ApplyCompanyQuery">
        select a.Id,a.ApplyNo,convert(varchar(20),a.OutDate,23) as 'OutDate',b.LineName,a.AllNumber,
        a.ContactName,a.ContactTel,a.Statu
        from Apply a join Line b on a.LineId = b.Id where a.CompanyName = #{CompanyName} and a.OutDate = #{OutTime}
        ORDER by a.OutDate desc
    </select>

    <select id="queryCompanyById" parameterType="long" resultType="eqlee.ctm.apply.entry.entity.query.Company">
        select * from Company where Id = #{Id}
    </select>


    <!-- 已审核的报名记录表  -->

    <select id="toListPageDoApply" resultType="eqlee.ctm.apply.entry.entity.query.ApplyDoExaQuery">
      select a.Id,a.ApplyNo,convert(varchar(20),a.OutDate,23) as 'OutDate',b.LineName,a.AdultNumber,a.BabyNumber,a.OldNumber,a.ChildNumber,
      a.statu,a.CompanyName,a.CompanyUser,a.IsPayment,a.IsCancel,d.ExamineType
      from Apply a join Line b on a.LineId = b.Id join Examine d on a.Id = d.ApplyId
      where a.Statu != 0 and d.ExamineResult != 0 ORDER by a.OutDate desc
    </select>

    <select id="toListPageDoApplyByNoWithLine" resultType="eqlee.ctm.apply.entry.entity.query.ApplyDoExaQuery">
        <bind name="lineName_name" value="'%' + LineName + '%'"/>
        select a.Id,a.ApplyNo,convert(varchar(20),a.OutDate,23) as 'OutDate',b.LineName,a.AdultNumber,a.BabyNumber,a.OldNumber,a.ChildNumber,
        a.statu,a.CompanyName,a.CompanyUser,a.IsPayment,a.IsCancel,d.ExamineType
        from Apply a join Line b on a.LineId = b.Id,d.ExamineType join Examine d on a.Id = d.ApplyId
        where a.OutDate = #{outDate} and b.LineName like #{lineName_name} and a.Statu != 0 and d.ExamineResult != 0
        ORDER by a.OutDate desc
    </select>

    <select id="toListPageDoApplyByLineName" resultType="eqlee.ctm.apply.entry.entity.query.ApplyDoExaQuery">
        <bind name="lineName_name" value="'%' + LineName + '%'"/>
        select a.Id,a.ApplyNo,convert(varchar(20),a.OutDate,23) as 'OutDate',b.LineName,a.AdultNumber,a.BabyNumber,a.OldNumber,a.ChildNumber,
        a.statu,a.CompanyName,a.CompanyUser,a.IsPayment,a.IsCancel,d.ExamineType
        from Apply a join Line b on a.LineId = b.Id join Examine d on a.Id = d.ApplyId
        where b.LineName like #{lineName_name} and a.Statu != 0 and d.ExamineResult != 0
        ORDER by a.OutDate desc
    </select>

    <select id="toListPageDoApplyByNo" resultType="eqlee.ctm.apply.entry.entity.query.ApplyDoExaQuery">
        select a.Id,a.ApplyNo,convert(varchar(20),a.OutDate,23) as 'OutDate',b.LineName,a.AdultNumber,a.BabyNumber,a.OldNumber,a.ChildNumber,
        a.statu,a.CompanyName,a.CompanyUser,a.IsPayment,a.IsCancel,d.ExamineType
        from Apply a join Line b on a.LineId = b.Id join Examine d on a.Id = d.ApplyId
        where a.OutDate = #{outDate} and a.Statu != 0 and d.ExamineResult != 0
        ORDER by a.OutDate desc
    </select>


    <!-- 已审核加类型的查询-->
    <select id="toListPageDoExa" resultType="eqlee.ctm.apply.entry.entity.query.ApplyDoExaQuery">
      select a.Id,a.ApplyNo,convert(varchar(20),a.OutDate,23) as 'OutDate',b.LineName,a.AdultNumber,a.BabyNumber,a.OldNumber,a.ChildNumber,
      a.statu,a.CompanyName,a.CompanyUser,a.IsPayment,a.IsCancel,d.ExamineType
      from Apply a join Line b on a.LineId = b.Id join Examine d on a.Id = d.ApplyId
      where a.Statu != 0 and d.ExamineResult != 0 and d.ExamineType = #{ApplyType} ORDER by a.OutDate desc
    </select>

    <select id="toListPageDoExaByNoWithLine" resultType="eqlee.ctm.apply.entry.entity.query.ApplyDoExaQuery">
        <bind name="lineName_name" value="'%' + LineName + '%'"/>
        select a.Id,a.ApplyNo,convert(varchar(20),a.OutDate,23) as 'OutDate',b.LineName,a.AdultNumber,a.BabyNumber,a.OldNumber,a.ChildNumber,
        a.statu,a.CompanyName,a.CompanyUser,a.IsPayment,a.IsCancel,d.ExamineType
        from Apply a join Line b on a.LineId = b.Id,d.ExamineType join Examine d on a.Id = d.ApplyId
        where a.OutDate = #{outDate} and b.LineName like #{lineName_name} and a.Statu != 0 and d.ExamineResult != 0 and d.ExamineType = #{ApplyType}
        ORDER by a.OutDate desc
    </select>

    <select id="toListPageDoExaByLineName" resultType="eqlee.ctm.apply.entry.entity.query.ApplyDoExaQuery">
        <bind name="lineName_name" value="'%' + LineName + '%'"/>
        select a.Id,a.ApplyNo,convert(varchar(20),a.OutDate,23) as 'OutDate',b.LineName,a.AdultNumber,a.BabyNumber,a.OldNumber,a.ChildNumber,
        a.statu,a.CompanyName,a.CompanyUser,a.IsPayment,a.IsCancel,d.ExamineType
        from Apply a join Line b on a.LineId = b.Id join Examine d on a.Id = d.ApplyId
        where b.LineName like #{lineName_name} and a.Statu != 0 and d.ExamineResult != 0 and d.ExamineType = #{ApplyType}
        ORDER by a.OutDate desc
    </select>

    <select id="toListPageDoExaByNo" resultType="eqlee.ctm.apply.entry.entity.query.ApplyDoExaQuery">
        select a.Id,a.ApplyNo,convert(varchar(20),a.OutDate,23) as 'OutDate',b.LineName,a.AdultNumber,a.BabyNumber,a.OldNumber,a.ChildNumber,
        a.statu,a.CompanyName,a.CompanyUser,a.IsPayment,a.IsCancel,d.ExamineType
        from Apply a join Line b on a.LineId = b.Id join Examine d on a.Id = d.ApplyId
        where a.OutDate = #{outDate} and a.Statu != 0 and d.ExamineResult != 0 and d.ExamineType = #{ApplyType}
        ORDER by a.OutDate desc
    </select>


    <!-- 未审核的取消报名记录表 -->

    <select id="listPageNotCancel" resultType="eqlee.ctm.apply.entry.entity.query.ApplyDoExaQuery">
      select a.Id,a.ApplyNo,convert(varchar(20),a.OutDate,23) as 'OutDate',b.LineName,a.AdultNumber,a.BabyNumber,a.OldNumber,a.ChildNumber,
      a.statu,a.CompanyName,a.CompanyUser,a.IsPayment,a.IsCancel,d.ExamineType
      from Apply a join Line b on a.LineId = b.Id join Examine d on a.Id = d.ApplyId where d.ExamineType = '1' and d.ExamineResult = 0 and a.IsPayment = 1
      ORDER by a.OutDate desc
    </select>

    <select id="listPageNotCancelByTimeWithLine" resultType="eqlee.ctm.apply.entry.entity.query.ApplyDoExaQuery">
        <bind name="lineName_name" value="'%' + LineName + '%'"/>
        select a.Id,a.ApplyNo,convert(varchar(20),a.OutDate,23) as 'OutDate',b.LineName,a.AdultNumber,a.BabyNumber,a.OldNumber,a.ChildNumber,
        a.statu,a.CompanyName,a.CompanyUser,a.IsPayment,a.IsCancel,d.ExamineType
        from Apply a join Line b on a.LineId = b.Id join Examine d on a.Id = d.ApplyId
        where a.OutDate = #{outDate} and b.LineName like #{lineName_name} and d.ExamineType = '1' and d.ExamineResult = 0 and a.IsPayment = 1
        ORDER by a.OutDate desc
    </select>

    <select id="listPageNotCancelByLineName" resultType="eqlee.ctm.apply.entry.entity.query.ApplyDoExaQuery">
        <bind name="lineName_name" value="'%' + LineName + '%'"/>
        select a.Id,a.ApplyNo,convert(varchar(20),a.OutDate,23) as 'OutDate',b.LineName,a.AdultNumber,a.BabyNumber,a.OldNumber,a.ChildNumber,
        a.statu,a.CompanyName,a.CompanyUser,a.IsPayment,a.IsCancel,d.ExamineType
        from Apply a join Line b on a.LineId = b.Id join Examine d on a.Id = d.ApplyId
        where b.LineName like #{lineName_name} and d.ExamineType = '1' and d.ExamineResult = 0 and a.IsPayment = 1
        ORDER by a.OutDate desc
    </select>

    <select id="listPageNotCancelByTime" resultType="eqlee.ctm.apply.entry.entity.query.ApplyDoExaQuery">
        select a.Id,a.ApplyNo,convert(varchar(20),a.OutDate,23) as 'OutDate',b.LineName,a.AdultNumber,a.BabyNumber,a.OldNumber,a.ChildNumber,
        a.statu,a.CompanyName,a.CompanyUser,a.IsPayment,a.IsCancel,d.ExamineType
        from Apply a join Line b on a.LineId = b.Id join Examine d on a.Id = d.ApplyId
        where a.OutDate = #{outDate} and d.ExamineType = '1' and d.ExamineResult = 0 and a.IsPayment = 1
        ORDER by a.OutDate desc
    </select>


    <!-- 我的报名记录 -->
    <select id="listPageDoApply2Me" resultType="eqlee.ctm.apply.entry.entity.query.ApplyCompanyQuery">
        select a.Id,a.ApplyNo,convert(varchar(20),a.OutDate,23) as 'OutDate',b.LineName,a.AllNumber,
        a.ContactName,a.ContactTel,a.Statu,a.IsCancel,a.IsPayment
        from Apply a join Line b on a.LineId = b.Id where a.CreateUserId =#{id}
        ORDER by a.OutDate desc
    </select>

    <select id="listPageDoApply2MeByTime" resultType="eqlee.ctm.apply.entry.entity.query.ApplyCompanyQuery">
       select a.Id,a.ApplyNo,convert(varchar(20),a.OutDate,23) as 'OutDate',b.LineName,a.AllNumber,
        a.ContactName,a.ContactTel,a.Statu,a.IsCancel,a.IsPayment
        from Apply a join Line b on a.LineId = b.Id where a.OutDate = #{OutDate} and a.CreateUserId =#{id}
        ORDER by a.OutDate desc
    </select>

    <select id="listPageDoApply2MeByName" resultType="eqlee.ctm.apply.entry.entity.query.ApplyCompanyQuery">
        <bind name="lineName_name" value="'%' + lineName + '%'"/>
        select a.Id,a.ApplyNo,convert(varchar(20),a.OutDate,23) as 'OutDate',b.LineName,a.AllNumber,
        a.ContactName,a.ContactTel,a.Statu,a.IsCancel,a.IsPayment
        from Apply a join Line b on a.LineId = b.Id where b.LineName like #{lineName_name} and a.CreateUserId =#{id}
        ORDER by a.OutDate desc
    </select>

    <select id="listPageDoApply2MeByNameAndTime" resultType="eqlee.ctm.apply.entry.entity.query.ApplyCompanyQuery">
        <bind name="lineName_name" value="'%' + lineName + '%'"/>
        select a.Id,a.ApplyNo,convert(varchar(20),a.OutDate,23) as 'OutDate',b.LineName,a.AllNumber,
        a.ContactName,a.ContactTel,a.Statu,a.IsCancel,a.IsPayment
        from Apply a join Line b on a.LineId = b.Id where b.LineName like #{lineName_name} and a.OutDate = #{OutTime} and a.CreateUserId =#{id}
        ORDER by a.OutDate desc
    </select>

    <select id="queryPayInfo" parameterType="Long" resultType="eqlee.ctm.apply.entry.entity.vo.ApplyOpenIdVo">
        select OpenId as 'openId' from PayInfo where UserId = #{userId}
    </select>

    <!-- 月结统计 -->
    <select id="queryMonthApply" resultType="eqlee.ctm.apply.entry.entity.query.ApplyMonthQuery">
        select a.Id,convert(varchar(20),a.OutDate,23) as 'OutDate',a.AllPrice,b.LineName,a.AllNumber,a.IsPayment,
        a.CompanyUser,a.ContactName from Apply a join Line b on a.LineId = b.Id
        where a.PayType = 1 and a.IsCancel = 0 ORDER by a.OutDate desc
    </select>

    <select id="queryMonthApplyByTime" resultType="eqlee.ctm.apply.entry.entity.query.ApplyMonthQuery">
        select a.Id,convert(varchar(20),a.OutDate,23) as 'OutDate',a.AllPrice,b.LineName,a.AllNumber,a.IsPayment,
        a.CompanyUser,a.ContactName from Apply a join Line b on a.LineId = b.Id
        where a.PayType = 1 and a.OutDate = #{outDate} and a.IsCancel = 0
        ORDER by a.OutDate desc
    </select>

    <select id="queryMonthWeiApply" resultType="eqlee.ctm.apply.entry.entity.query.ApplyMonthQuery">
        select a.Id,convert(varchar(20),a.OutDate,23) as 'OutDate',a.AllPrice,b.LineName,a.AllNumber,a.IsPayment,
        a.CompanyUser,a.ContactName from Apply a join Line b on a.LineId = b.Id
        where a.PayType = 1 and a.IsPayment = 0 and a.IsCancel = 0
        ORDER by a.OutDate desc
    </select>

    <select id="queryMonthWeiApplyByTime" resultType="eqlee.ctm.apply.entry.entity.query.ApplyMonthQuery">
        select a.Id,convert(varchar(20),a.OutDate,23) as 'OutDate',a.AllPrice,b.LineName,a.AllNumber,a.IsPayment,
        a.CompanyUser,a.ContactName from Apply a join Line b on a.LineId = b.Id
        where a.PayType = 1 and a.IsPayment = 0 and a.OutDate = #{outDate} and a.IsCancel = 0
        ORDER by a.OutDate desc
    </select>

    <select id="queryMonthYiApply" resultType="eqlee.ctm.apply.entry.entity.query.ApplyMonthQuery">
        select a.Id,convert(varchar(20),a.OutDate,23) as 'OutDate',a.AllPrice,b.LineName,a.AllNumber,a.IsPayment,
        a.CompanyUser,a.ContactName from Apply a join Line b on a.LineId = b.Id
        where a.PayType = 1 and a.IsPayment = 1 and a.IsCancel = 0 ORDER by a.OutDate desc
    </select>

    <select id="queryMonthYiApplyByTime" resultType="eqlee.ctm.apply.entry.entity.query.ApplyMonthQuery">
        select a.Id,convert(varchar(20),a.OutDate,23) as 'OutDate',a.AllPrice,b.LineName,a.AllNumber,a.IsPayment,
        a.CompanyUser,a.ContactName from Apply a join Line b on a.LineId = b.Id
        where a.PayType = 1 and a.IsPayment = 1 and a.OutDate = #{outDate} and a.IsCancel = 0
        ORDER by a.OutDate desc
    </select>


    <select id="queryUserById" parameterType="Long" resultType="eqlee.ctm.apply.entry.entity.query.User">
        select * from SystemUser where Id = #{id}
    </select>

</mapper>